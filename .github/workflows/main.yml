name: Foodgram Workflow

on: [push]

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/src/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip 
          pip install flake8, flake8-import-order, flake8-isort
          cd backend/src
          pip install -r requirements.txt
          pip install --upgrade urllib3 chardet
            

      - name: Run linter
        run: |
          cd backend/src
          flake8 --exclude=migrations

      - name: Run tests
        run: |
          cd backend/src
          python manage.py test
        env:
          DB_ENGINE: ${{ secrets.DB_ENGINE }}
          DB_NAME: ${{ secrets.DB_NAME }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          DB_HOST: localhost
          DB_PORT: ${{ secrets.DB_PORT }}
      
      - name: Wait for PostgreSQL to start
        run: |
          while ! pg_isready -h localhost -p 5432 > /dev/null 2> /dev/null; do
            sleep 1
          done

  build_and_push_to_docker_hub:
    name: Push image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
            
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/foodgram-backend:latest
          context: .
          file: backend/src/Dockerfile.prod

  update_configs:
    name: Update configs
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          source: "infra/docker-compose.prod.yml,infra/nginx.conf"
          target: "./"
          strip_components: 1

  deploy:
    name: Deploy to Yandex.Cloud
    runs-on: ubuntu-latest
    needs: [build_and_push_to_docker_hub, update_configs]

    steps:
      - name: Executing remote ssh commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          script: |
            sudo systemctl stop nginx
            sudo systemctl stop gunicorn

            touch .env
            echo "DB_ENGINE=${{ secrets.DB_ENGINE }}" > .env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
            echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
            echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env

            # –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            sudo docker-compose -f docker-compose.prod.yml stop

            # —Å–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–∑ foodgram-backend
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/foodgram-backend:latest

            # –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            sudo docker-compose -f docker-compose.prod.yml up -d

            # –≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏, —Å–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            sudo docker-compose -f docker-compose.prod.yml exec -T backend python manage.py migrate
            sudo docker-compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --no-input
            sudo docker-compose -f docker-compose.prod.yml exec -T backend python manage.py import_basic_data ../data/
        

  send_message:
    name: Send message
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Send success message to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "Foodgram workflow finished successfully! üéâ "
